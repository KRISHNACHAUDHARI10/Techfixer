<%- include('../includes/navbar.ejs') %>

<section class="h-100">
  <div class="container bg-light h-100 my-4 py-4">
    <% if(services.length > 0) { %>
    <div class="row d-flex justify-content-center align-items-center h-100">
      <div class="col-11">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="fw-normal mb-0">Shopping Cart</h3>
        </div>

        <% for(let i = 0; i < services.length; i++) { %>
        <div class="row">
          <div class="card shadow rounded-3 mb-4 cart-item">
            <div class="card-body p-4">
              <div class="row d-flex justify-content-between align-items-center">
                <div class="col-md-2 col-lg-2 col-xl-2">
                  <img src="<%= services[i].service_image %>" class="img-fluid rounded-3" alt="<%= services[i].service_name %>">
                </div>
                <div class="col-md-2 col-lg-2 col-xl-2">
                  <p class="lead fw-normal mb-2 servicename"><%= services[i].service_name %></p>
                  <p><span class="text-muted">Time: </span> <%= services[i].time %> min</p>
                </div>
                <div class="col-md-2 col-lg-2 col-xl-2 text-center">
                  <h5><span class="text-muted"> Price: ₹</span> <span class="price"><%= services[i].price %>.00</span></h5>
                </div>
                <div class="col-md-3 col-lg-3 col-xl-2 d-flex text-center">
                  <button class="btn btn-link px-2" onclick="this.parentNode.querySelector('input[type=number]').stepDown(); bill();">
                    <i class="fas fa-minus"></i>
                  </button>
                  <input id="form1" min="0" name="quantity" value="1" type="number" class="form-control quantity form-control-sm text-center" />
                  <button class="btn btn-link px-2" onclick="this.parentNode.querySelector('input[type=number]').stepUp(); bill();">
                    <i class="fas fa-plus"></i>
                  </button>
                </div>
                <div class="col-md-2 col-lg-2 col-xl-2 offset-md-">
                  <h5 class="mb-0 text-center">₹<span class="item-total">0</span></h5>
                </div>
                <div class="col-md-1 col-lg-1 col-xl-1 text-end">
                  <a href="/user/removeService?service=<%= services[i]._id %>">
                    <button class="btn btn-outline-danger btn-lg"><i class="fas fa-trash fa-lg"></i></button>
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <section id="cart-bottom" class="container border-box">
          <div class="row bg-light">
            <div class="col-lg-6 col-md-6 col-12 mb-1 p-5">
              <form>
                <h5>Coupon</h5>
                <p>Enter your coupon code if you have one</p>
                <input type="text" class="form-control" placeholder="Coupon code" />
                <button type="submit" class="btn btn-primary mt-2">Apply Coupon</button>
              </form>
            </div>

            <div class="col-lg-6 col-md-6 col-12 p-4">
              <div class="shadow p-3">
                <h5>Cart Total</h5>
                <div class="d-flex justify-content-between">
                  <h6>Subtotal</h6>
                  <p id="subtotal">₹0</p>
                </div>
                <div class="d-flex justify-content-between">
                  <h6>Total</h6>
                  <p id="total">₹0</p>
                </div>
                <hr />
                <form action="/user/checkout" method="post">
                  <input type="hidden" name="data" id="person" >
                  <button class="btn btn-success w-100">Proceed to Checkout</button>
                </form>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>
    <% } else { %>
    <div class="row p-4">
      <div class="col-md-6 offset-md-3 text-center">
        <img src="/images/emptyCart.jpg" alt="" height="350px">
        <a href="/user/service">
          <button class="btn btn-outline-danger mt-3 btn-lg" style="color:white; background-color: rgb(238, 163, 176);">Shop now</button>
        </a>
      </div>
    </div>
    <% } %>
  </div>

</section>

<script>
  // This will receive the data passed from the server

  // Function to update the bill
  function bill() {
    let price = document.getElementsByClassName('price');
    let quantity = document.getElementsByClassName('quantity');
    let item_name = document.getElementsByClassName('servicename');
    let itemtotal = document.getElementsByClassName('item-total');
    let subtotal = document.getElementById('subtotal');
    let total = document.getElementById('total');
    let sum = 0;

    // Create an object to store item quantities
    let orders = { product: {} };

    for (let i = 0; i < price.length; i++) {
        // Calculate item total for each service
        itemtotal[i].innerText = (Number(price[i].innerText) * quantity[i].value).toFixed(2);
        sum += Number(itemtotal[i].innerText);

        // Store quantities in the orders object by item name
        let itemName = item_name[i].innerText.trim();
        let array = [Number(quantity[i].value) , Number((Number(price[i].innerText)))]
        orders.product[itemName] =array;
    }

    // Update the subtotal and total
    subtotal.innerText = "₹" + sum.toFixed(2);
    total.innerText = "₹" + sum.toFixed(2);

    // Add subtotal and total to the orders object
    orders.subtotal = sum;
    orders.total = sum;

    // Update the hidden input with the updated data
    document.getElementById('person').value = JSON.stringify(orders);
}

// Call the function on page load to initialize the bill
bill();

 
</script>

<%- include('../includes/footer.ejs') %>
